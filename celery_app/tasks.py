import asyncio

from celery_app.celery import celery
import core.database.requests as rq
import requests

from core.settings import settings
import core.handlers.texts as txt

import nest_asyncio


BOT_TOKEN = settings.BOT_TOKEN

def send_notif(ids: list):
    if not BOT_TOKEN:
        print("‚ö†Ô∏è Telegram bot token –∏–ª–∏ chat ID –Ω–µ –∑–∞–¥–∞–Ω—ã")
        return
    loop = asyncio.get_event_loop()
    if loop.is_running():
        nest_asyncio.apply()
    kp = loop.run_until_complete(txt.get_kp_forecast_report(only_max=True))
    if kp < 4:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî —Å–ø–æ–∫–æ–π–Ω–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞.\n\n"
            "üîπ <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π —á—É–≤—Å—Ç–≤—É—é—Ç —Å–µ–±—è —Ö–æ—Ä–æ—à–æ. –†–µ–¥–∫–æ –æ—Ç–º–µ—á–∞—é—Ç—Å—è –∂–∞–ª–æ–±—ã.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    elif kp < 5:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî –Ω–µ—É—Å—Ç–æ–π—á–∏–≤–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞.\n\n"
            "üî∏ <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –≤–æ–∑–º–æ–∂–Ω—ã –ª—ë–≥–∫–∏–µ –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏—è —É –º–µ—Ç–µ–æ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ª—é–¥–µ–π: –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, —É—Å—Ç–∞–ª–æ—Å—Ç—å, –ø–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    elif kp < 6:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî —Å–ª–∞–±–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è.\n\n"
            "‚ö†Ô∏è <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> —É –º–µ—Ç–µ–æ–∑–∞–≤–∏—Å–∏–º—ã—Ö ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —É—Ç–æ–º–ª—è–µ–º–æ—Å—Ç—å, –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ, —Å–∫–∞—á–∫–∏ –¥–∞–≤–ª–µ–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑–±–µ–≥–∞—Ç—å —Å—Ç—Ä–µ—Å—Å–æ–≤ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    elif kp < 7:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è.\n\n"
            "‚ùó <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è —É —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ª—é–¥–µ–π. –í–æ–∑–º–æ–∂–Ω—ã –±–æ–ª–∏ –≤ —Å—É—Å—Ç–∞–≤–∞—Ö, —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ, –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å–Ω–∞. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–¥–æ—Ä–æ–≤—å—è.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    elif kp < 8:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî —Å–∏–ª—å–Ω–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è.\n\n"
            "‚ùó‚ùó <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —É—Ö—É–¥—à–µ–Ω–∏—è: –≥–æ–ª–æ–≤–Ω—ã–µ –±–æ–ª–∏, –¥–∞–≤–ª–µ–Ω–∏–µ, —Å–µ—Ä–¥–µ—á–Ω—ã–µ –ø—Ä–∏—Å—Ç—É–ø—ã —É –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã—Ö. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Ä–µ–∂–∏–º–∞, –∏–∑–±–µ–≥–∞—Ç—å –∞–ª–∫–æ–≥–æ–ª—è –∏ –∫–æ—Ñ–µ.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    elif kp < 9:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è.\n\n"
            "‚ùå <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –≤–æ–∑–º–æ–∂–Ω—ã —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –¥–∞–∂–µ —É –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π. –õ—é–¥—è–º —Å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è–º–∏ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )
    else:
        desc = (
            f"–°–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Kp-–∏–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç <b>{kp}</b> ‚Äî —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è.\n\n"
            "üÜò <b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è. –í–æ–∑–º–æ–∂–Ω—ã –æ–±–æ—Å—Ç—Ä–µ–Ω–∏—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π, —Å–∫–∞—á–∫–∏ –¥–∞–≤–ª–µ–Ω–∏—è, –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ–º, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.\n"
            "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ 'üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'."
        )

    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    for user_id in ids:
        payload = {
            "chat_id": user_id,
            "text": desc,
            "parse_mode": "HTML",
            "reply_markup":  {
                "inline_keyboard": [
                    [
                        {"text": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "callback_data": "settings"},
                    ],
                    [
                        {"text": "üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞", "callback_data": "predict_weather"}
                    ],
                    [
                        {"text": "üìä –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è", "callback_data": "now_weather"}
                    ]
                ]
            }
        }
        try:
            requests.post(url, json=payload, timeout=5)
        except Exception as ex:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TG: {ex}")


def send_query(ids: list):
    if not BOT_TOKEN :
        print("‚ö†Ô∏è Telegram bot token –∏–ª–∏ chat ID –Ω–µ –∑–∞–¥–∞–Ω—ã")
        return
    print("TRY")
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    for i in ids:
        payload = {
            "chat_id": i,
            "text": f"–ö–∞–∫ –≤—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ —Å–µ–±—è —Å–µ–≥–æ–¥–Ω—è?",
            "parse_mode": "Markdown",
            "reply_markup": {
                "inline_keyboard": [
                    [
                        {"text": "üôÇ –í—Å–µ —Ö–æ—Ä–æ—à–æ", "callback_data": "query all_good"},
                        {"text": "ü´© –°–ª–∞–±–æ—Å—Ç—å", "callback_data": "query weakness"}
                    ],
                    [
                        {"text": "ü´® –ì–æ–ª–æ–≤–Ω—ã–µ –±–æ–ª–∏", "callback_data": "query head_pain"}
                    ]
                ]
            }
        }
        try:
            requests.post(url, json=payload, timeout=5)
        except Exception as ex:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TG: {ex}")

@celery.task
def send_notification():
    try:
        loop = asyncio.get_event_loop()
        if loop.is_running():
            nest_asyncio.apply()
        users_ids = loop.run_until_complete(rq.get_user_ids(for_notifications=True))
        send_notif(users_ids)
    except Exception as e:
        error_msg = f"{type(e).__name__}: {e}"
        print(f"‚ùå –û—à–∏–±–∫–∞: {error_msg}")



@celery.task
def query_user():
    loop = asyncio.get_event_loop()
    if loop.is_running():
        nest_asyncio.apply()
    ids = loop.run_until_complete(rq.get_user_ids(for_qwery=True))
    send_query(ids)
